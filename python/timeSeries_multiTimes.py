"""
Analyze multiple tables of time series samples generated by timeSeries_slimHistory.py
tianlin.duan42@gmail.com
2024.06.06
"""
############################# modules #########################################
import msprime
import tskit
import pyslim
import matplotlib.pyplot as plt
import scipy.stats as stats
from scipy.spatial import distance_matrix
import numpy as np
import random
from time import time
import sys  # for sys.exit()
import allel  # for allel.weir_cockerham_fst()
import os  # mkdir
import pandas  #dataframe
import glob  #for loading files

############################# program #########################################
inPath_filePrefix = "/home/tianlin/Documents/github/data/tskit_data/output/table/historical_optimum0_timeSeries/Continuous_nonWF_M2b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12/Continuous_nonWF_M2b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_seed1605901219043795304_tick"
model_name = "_".join(inPath_filePrefix.split("/")[-1].split("_")[0:-1])
fileSuffix = "_functionalMut_table.txt"
figPath = "/home/tianlin/Documents/github/data/tskit_data/figure/20240605/"
# outBasePath = "/home/tianlin/Documents/github/data/tskit_data/output/table/historical_optimum0_timeSeries/"
times = np.array([50, 100, 200, 300, 400, 800, 1000, 2000, 4000, 10000, 20000,
                  30000, 40000, 100000])
history = 100000
ticks = np.array([str(t + history) for t in times])
dataTable = np.empty((7, 0))
# Load results from multiple files
fileList = np.char.add(np.char.add(np.array([inPath_filePrefix]),
                                   ticks),
                       np.array([fileSuffix]))
i = 0
for f in fileList:
    focal_tick = times[i]
    focalTable = np.loadtxt(f)
    # print(np.shape(focalTable))
    relative_lf_mut = focalTable[4] / sum(focalTable[4])
    # Add a column ticks and relative LF_mut
    focalTable = np.concatenate((focalTable,
                                 np.full(shape=(1, np.shape(focalTable)[1]),
                                         fill_value=focal_tick),
                                 [relative_lf_mut]),
                                axis=0)
    dataTable = np.concatenate((dataTable, focalTable), axis=1)
    i += 1

# Change to pandas dataframe
dataTable_t = dataTable.transpose()
df = pandas.DataFrame(data=dataTable_t,
                      columns=["pos", "age", "freq",
                               "effect_size", "lf_mut", "time",
                               "relative_lf"])

# median freq ~ time
median_freqs = []
for t in times:
    focal_median = np.median(df[df["time"] == t]["freq"])
    median_freqs.append(focal_median)

plt.figure(figsize=(12,5))
plt.plot(times, median_freqs,
         marker="o", markersize=5, markerfacecolor="white",
         color="black")
plt.xlabel("Generations after the environmental change")
plt.ylabel("Median allele frequency of segregating functional mutations")
plt.savefig(figPath + model_name + "_medianFreq_through_time_100000.png",
            dpi=300)
plt.close()

# median size ~ time
median_sizes = []
for t in times:
    focal_median = np.median(df[df["time"] == t]["effect_size"])
    median_sizes.append(focal_median)

plt.figure(figsize=(12,5))
plt.plot(times, median_sizes,
         marker="o", markersize=5, markerfacecolor="white",
         color="black")
plt.xlabel("Generations after the environmental change")
plt.ylabel("Median phenotypic effect size of segregating functional mutations")
plt.savefig(figPath + model_name + "_medianSize_through_time_100000.png",
            dpi=300)
plt.close()

# Relative contribution (sum(positive LF_mut)) from alleles of each frequency bin
num_cat = 10
freq_cats = np.append(np.arange(0, 1, 1.0 / num_cat),
                      1)
lf_by_freq_positive = np.full(shape=(num_cat, len(times)), fill_value=np.nan)
lf_by_freq_negative = np.full(shape=(num_cat, len(times)), fill_value=np.nan)
for t in range(len(times)):
    focal_time = times[t]
    focal_lf_mut = df[df["time"] == focal_time]["relative_lf"]
    focal_freq = df[df["time"] == focal_time]["freq"]
    for i in range(num_cat):
        lf_category = focal_lf_mut[np.logical_and(focal_freq > freq_cats[i],
                                                  focal_freq <= freq_cats[
                                                           i + 1])]
        lf_by_freq_positive[i][t] = sum(lf_category[lf_category > 0])
        lf_by_freq_negative[i][t] = sum(lf_category[lf_category < 0])

# Line plots: not used
freq10colors = ["#d2ebf3FF", "#9dcde3FF", "#6899CEFF", "#4074cbFF", "#1839aaFF",
                "#1624a1FF", "#523cb7FF", "#8f69caFF", "#c2a0dfFF", "#e5d0f0FF"]
plt.figure(figsize=(12,5))
for i in range(10):
    plt.plot(times, lf_by_freq_positive[i],
             marker="o", markersize=5, markerfacecolor="white",
             color=freq10colors[i])
plt.xlabel("Generations after the environmental change")
plt.ylabel("Contribution to local adaptation (sigma LF)")
plt.savefig(figPath + model_name + "_relativelfByFreq10Bin_through_time_100000.png",
            dpi=300)
plt.close()


freq10colors = ["#d2ebf3FF", "#9dcde3FF", "#6899CEFF", "#4074cbFF", "#1839aaFF",
                "#1624a1FF", "#523cb7FF", "#8f69caFF", "#c2a0dfFF", "#e5d0f0FF"]
labels = []
plt.figure(figsize=(12,5))
plt.stackplot(times, lf_by_freq_positive, labels=labels,
              colors=freq10colors)
plt.xlabel("Generations after the environmental change")
plt.ylabel("Contribution to local adaptation (sigma LF)")
plt.savefig(figPath + model_name + "_relativelfByFreq10Bin_stack_through_time_100000.png",
            dpi=300)
plt.close()