"""
Making summarizing plots for multiple SLiM runs, using the tables generated by
alleleAge_slimHistory.py
tianlin.duan42@gmail.com
2024.05.09
"""
############################# modules #########################################
import matplotlib
import msprime
import tskit
import pyslim
import matplotlib
import matplotlib.pyplot as plt
import scipy.stats as stats
from scipy.spatial import distance_matrix
import numpy as np
import random
from time import time
import sys # for sys.exit()
import allel # for allel.weir_cockerham_fst()
import glob #for loading files
from collections import Counter
import pandas as pd#dataframe
import os #mkdir
# matplotlib.use("qt5agg") # Not work
import matplotlib.pyplot as plt
import scipy.stats as stats
import sys # for sys.exit()
import allel # for allel.weir_cockerham_fst()
import matplotlib.patches as mpatches # manually make legends
import seaborn as sns

############################# options #############################
import argparse
parser = argparse.ArgumentParser()
# Path should end by "/"
parser.add_argument('-i', '--input',
                    help='Path the the input tables',
                    type=str)
# #parser.add_argument('-n', '--name',
#                     help='Short model name',
#                     type=str)
# #parser.add_argument('-p', '--plot',
#                     help='1 for generating plots and 0 for not plotting',
#                     type=int, default=1)
args = parser.parse_args()

############################# program #########################################
# Values
# sigma_w = 0.4
# dist_mate = 0.12
num_runs = 200
inPath = args.input
# inPath = "/home/tianlin/Documents/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_K17000_r1.0e-07/tick110000/"
# inPath = "/home/tianlin/Documents/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.06_mateD0.15_K17000_r1.0e-07/tick110000/"
#inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M3b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_K17000_r1.0e-07/tick110000/"
# inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_patchyMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_K17000_r1.0e-07/tick110000/"
# inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_patchyMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.06_mateD0.15_K17000_r1.0e-07/tick110000/"
# inPath = "/media/anadem/PortableSSD/UBC_dell_20240917/Documents/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_patchyMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.06_mateD0.15_K17000_r1.0e-07/tick110000/"
# inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M3a_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_K17000_r1.0e-07/tick110000/"
# inPath = "/media/anadem/PortableSSD/UBC_dell_20240917/Documents/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M2b_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.03_mateD0.12_K17000_r1.0e-07/tick110000/"
# inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M3a_glacialHistoryOptimum0_clineMap_mu1.0e-10_sigmaM0.1_sigmaW0.4_sigmaD0.06_mateD0.15_K17000_r1.0e-07/tick110000/"
# inPath = "/home/anadem/github/data/tskit_data/output/table/realistic_fpr_comparisons/Continuous_nonWF_M3a_glacialHistoryOptimum0_clineMap_mu1.0e-08_sigmaM0.01_sigmaW0.4_sigmaD0.06_mateD0.15_K17000_r1.0e-07/tick110000/"

short_model_name = inPath.split("/")[-3]
# figPath = ("/home/anadem/github/data/tskit_data/figure/20250109/variedRefugia/" +
#            short_model_name + "/" + str(num_runs) + "runs_" +
#            inPath.split("/")[-2]+"/")
figPath = ("/home/anadem/github/data/tskit_data/figure/20250131m3ab/" +
           short_model_name + "/" + str(num_runs) + "runs_" +
           inPath.split("/")[-2]+"/")
# figPath = ("/home/anadem/github/data/tskit_data/figure/20250114_m3_200runs/" +
#            short_model_name + "/" + str(num_runs) + "runs_" +
#            inPath.split("/")[-2]+"/")
# figPath = ("/home/tianlin/Documents/github/data/tskit_data/figure/20240909/" +
#            short_model_name + "/" + str(num_runs) + "runs_" +
#            inPath.split("/")[-2]+"/")
# outPath = ("/home/tianlin/Documents/github/data/tskit_data/output/multiple_runs/" +
#            short_model_name + "/100runs_" + inPath.split("/")[-2]+"/")
# if not os.path.exists(outPath):
#     os.makedirs(outPath)
if not os.path.exists(figPath):
    os.makedirs(figPath)

# Check this before use!
model_name = "_".join(inPath.split("/")[-3:-1] + ["100runs"])
tick = int(inPath.split("/")[-2].split("tick")[-1])
event_age = tick - 100000

# Shape of the table:
# dataTable[0]     mutation ID
# dataTable[1]     age,
# dataTable[2]     freq,
# dataTable[3]     mut_effect,
# dataTable[4]     delta_LF_mut,
# dataTable[5]     cor_GE[0]: Kandell's tau
# dataTable[6]     cor_GE[1]: p-value
# dataTable[7]     relative to the sum of positive delta_LF_mut (delta_LF_mut/sum of positive LF_mut )
# dataTable[8]     relative to sum of delta_LF_mut (delta_LF_mut/sum of LF_mut )
# dataTable[9]     temperary run ID 0,1,2...(number of files-1)
# dataTable[10]    rank of p-values
df = pd.DataFrame()
# Load results of multiple runs from file
fileList = glob.glob(inPath + "*.txt")
run = 0
for f in fileList:
    df_focal = pd.read_csv(f, sep='\t', header=0)
    # Add relative delta_LF_mut,temporary run ID, and rank of p-values
    lf_sum_positive = sum(df_focal.loc[df_focal["delta_LF_mut"]>0,"delta_LF_mut"])
    lf_sum = sum(df_focal["delta_LF_mut"])
    df_focal["relative_positive_lf"] = (df_focal["delta_LF_mut"] /
                                              lf_sum_positive)
    df_focal["relative_lf"] = df_focal["delta_LF_mut"] / lf_sum
    df_focal["run_id"] = np.full(shape=(df_focal.shape[0], 1),
                                         fill_value=run)
    # df_focal["p_rank"] = df_focal["p"].argsort().argsort()
    df_focal["p_rank"] = df_focal["p"].rank(ascending=True, pct=True)
    df = pd.concat([df, df_focal], axis=0)
    run += 1
print(str(run) + " files have been loaded.")
# Columns: "id", "age", "freq", "mut_effect","delta_LF_mut",
#          "tau", "p", "relative_positive_lf", "relative_lf", "run_id",
#          "p_rank"

# # No MAF filter: Not used
# # True positive rate, False negative rate, False discovery rate in all alleles
# # True adaptive allele: account for more than LF_min percent of positve LF_mut
# # GEA significant: BH-adjusted p-value < 0.05
# LF_min = 0.01
# num_cat = 20
# cat_width = int(100/num_cat) if 100 % num_cat == 0 else 100/num_cat
# age_percentile = np.percentile(df["age"],
#                                np.append(np.arange(0, 100, cat_width),
#                                          100))
# event_percentile = stats.percentileofscore(df["age"], event_age)
# TPR = []
# FPR = []
# FDR = []
#
# for i in range(num_cat):
#     focal_age = np.logical_and(df["age"] > age_percentile[i],
#                                df["age"] <= age_percentile[i+1])
#     df_category = df.loc[focal_age,:]
#     # num_allele = len(p_BH_category)
#     # proportion_sig.append(sum(p_BH_category < 0.05)/num_allele)
#     expP = df_category["relative_lf"] > LF_min
#     obsP = df_category["p"] < 0.05
#     TP = sum(expP & obsP)
#     FP = sum(~expP & obsP)
#     FN = sum(expP & ~obsP)
#     TN = sum(~expP & ~obsP)
#     TPR.append(TP/(TP+FN))
#     FPR.append(FP/(TN+FP))
#     FDR.append(FP/(TP+FP))



# Average p-rank of true-positives along age percentiles.
# Exclude alleles with minor allele frequency < 0.05
freq_cutoff = 0.05
# empirical_p_threshold = 0.0005
empirical_p_threshold = 0.05
# empirical_p_threshold = 0.0001
print_empirical_p_threshold = "{:.02e}".format(empirical_p_threshold)
# empirical_p_threshold = 0.05
# Define real positive: relative_LFmut > 0.01
LF_min = 0.01
df_mafPassed = df.loc[0.5-abs(df["freq"]-0.5) > freq_cutoff, :]
# Recalculate p-rank for alleles with minor allele frequency > 0.05
# p_rank_mafPassed = []
# for i in range(num_runs):
#     focal_p = df_mafPassed.loc[df_mafPassed["run_id"] == i, "p"]
#     p_rank_mafPassed.extend(list(focal_p.argsort().argsort()))

df_mafPassed.loc[
    :, "p_rank_mafPassed"
] = df_mafPassed.loc[:, ["run_id", "p"]].groupby(["run_id"]).rank(
    ascending=True, pct=True
).loc[:, "p"]
num_cat = 10
cat_width = int(100/num_cat) if 100 % num_cat == 0 else 100/num_cat
age_percentile = np.percentile(df_mafPassed["age"],
                               np.append(np.arange(0, 100, cat_width),
                                         100))
# average_pRank_realPositive = []
# average_pRank_realPositive_cohort = []
# Performance of two methods by cohorts and runs: version1, mean values
TPR_mafPassed = []
FPR_mafPassed = []
FDR_mafPassed = []
# Calculted by age cohorts
TPR_cohort = []
FPR_cohort = []
FDR_cohort = []
for i in range(num_cat):
    age_in_range = np.logical_and(
        df_mafPassed.loc[:, "age"] > age_percentile[i],
        df_mafPassed.loc[:, "age"] <= age_percentile[i+1]
    )
    df_cohort = df_mafPassed.loc[
        age_in_range,
        ["relative_lf", "p", "p_rank_mafPassed", "run_id"]
    ]
    df_cohort.loc[:, "p_rank_cohort"] = df_cohort.groupby("run_id").rank(
        ascending=True,
        pct=True
    ).loc[:, "p"]
    focal_expP = (df_cohort.loc[:, "relative_lf"] >= LF_min)
    # print(sum(focal_expP))
    # focal_expN = df_cohort.loc[df_cohort.loc[:, "relative_lf"] < LF_min, :]
    focal_obsP_mafPassed = (df_cohort.loc[:, "p_rank_mafPassed"] <
                            empirical_p_threshold)
    focal_obsP_cohort = (df_cohort.loc[:, "p_rank_cohort"] <
                         empirical_p_threshold)
    TP_mafPassed = sum(focal_expP & focal_obsP_mafPassed)
    FP_mafPassed = sum(~focal_expP & focal_obsP_mafPassed)
    FN_mafPassed = sum(focal_expP & ~focal_obsP_mafPassed)
    TN_mafPassed = sum(~focal_expP & ~focal_obsP_mafPassed)
    TPR_mafPassed.append(TP_mafPassed/(TP_mafPassed+FN_mafPassed))
    FPR_mafPassed.append(FP_mafPassed/(TN_mafPassed+FP_mafPassed))
    FDR_mafPassed.append(FP_mafPassed/(TP_mafPassed+FP_mafPassed))
    # Calculated by cohorts
    TP_cohort = sum(focal_expP & focal_obsP_cohort)
    FP_cohort = sum(~focal_expP & focal_obsP_cohort)
    FN_cohort = sum(focal_expP & ~focal_obsP_cohort)
    TN_cohort = sum(~focal_expP & ~focal_obsP_cohort)
    TPR_cohort.append(TP_cohort/(TP_cohort+FN_cohort))
    FPR_cohort.append(FP_cohort/(TN_cohort+FP_cohort))
    FDR_cohort.append(FP_cohort/(TP_cohort+FP_cohort))
    # average_pRank_realPositive.append(
    #     np.median(df_cohort.loc[df_cohort["relative_lf"] > LF_min,
    #     "p_rank_mafPassed"])
    # )
    # average_pRank_realPositive_cohort.append(
    #     np.median(df_cohort.loc[df_cohort.loc[:,"relative_lf"] > LF_min,
    #     "p_rank_cohort"])
    # )

# # Median p-rank ～ Allele age, equal number alleles per bin
# x_ticks = np.append(np.arange(0, 100, cat_width),100)
# # x_labels = [str(i)+"\n\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
# x_labels = x_ticks
# plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
#          average_pRank_realPositive_cohort,
#          color="grey",
#          marker="o")
# plt.xlabel("\n\nAllele age percentile bins")
# plt.ylabel("Median rank of p-values of adaptive alleles \n(relative LF_mut > "+
#            str(LF_min) +")")
# # Add annotations of age percentiles
# for i in range(num_cat + 1):
#     # label = "{:.5f}".format(age_percentile[i])
#     label = str(int(age_percentile[i]))
#     print(label)
#     x = np.arange(0, 101+cat_width, 100/num_cat)[i]
#     # y = -0.06 * np.nanmax(average_pRank_realPositive_cohort, ) #Patchy low mig
#     y = -0.15 * np.nanmax(average_pRank_realPositive_cohort, ) # Cline
#     plt.annotate(label,
#                  (x,y),
#                  textcoords="offset points",
#                  xytext=(-1*cat_width, 0.5*cat_width),
#                  annotation_clip=False,
#                  color="grey",
#                  rotation=30,
#                  ha='left')
#     plt.xticks([], minor=False)
# plt.xticks(ticks=x_ticks,
#            labels=x_labels,
#            rotation=20,
#            ha='left')
# plt.tight_layout()
# plt.savefig(figPath+model_name +
#             str(num_cat)+"bins" +
#             "_mafPassedPRankLFmut" + str(LF_min) + "_vs_age_equalNumber_rankBycohort.png",
#             dpi=300)
# plt.close()

# Plot: Compare TPR～ Allele age that were calculated in two different ways
# Only mean
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         TPR_mafPassed,
         color="grey",
         marker="o",
         alpha=0.6,
         label = "P-rank_all")
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         TPR_cohort,
         color="mediumaquamarine",
         marker="o",
         alpha=0.6,
         label="P-rank_cohort")
plt.xlabel("\n\nAllele age percentile bins")
plt.ylabel("True positive rate (TP/(TP+FN))")
# plt.title(r"$\alpha$ = " + str(empirical_p_threshold))
plt.title("Rank threshold " + str(print_empirical_p_threshold))
plt.legend()
# Add annotations of age percentiles
maxValue = np.nanmax(TPR_mafPassed+TPR_cohort)
minValue = np.nanmin(TPR_mafPassed+TPR_cohort)
annotate_loc = minValue - 0.27 * (maxValue - minValue)
for i in range(num_cat + 1):
    # label = "{:.5f}".format(age_percentile[i])
    label = str(int(age_percentile[i]))
    x = np.arange(0, 101+cat_width, 100/num_cat)[i]
    y = annotate_loc
    plt.annotate(label,
                 (x,y),
                 textcoords="offset points",
                 xytext=(-1*cat_width, 0.5*cat_width),
                 annotation_clip=False,
                 color="grey",
                 rotation=30,
                 ha='left')
    plt.xticks([], minor=False)
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath + model_name +
            str(num_cat)+"bins" +
            "_mafPassedPRankLFmut" + str(LF_min) +
            "_alpha" + str(print_empirical_p_threshold) +
            "_TPRByAgecohort.png",
            dpi=300)
plt.close()

# Compare FPR～ Allele age that were calculated in two different ways
# Only mean
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FPR_mafPassed,
         color="grey",
         marker="o",
         alpha=0.6,
         label = "P-rank_all")
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FPR_cohort,
         color="mediumaquamarine",
         marker="o",
         alpha=0.6,
         label = "P-rank_cohort")
plt.xlabel("\n\nAllele age percentile bins")
plt.ylabel("False positive rate (FP/(FP+TN))")
# plt.title(r"$\alpha$ = " + str(empirical_p_threshold))
plt.title("Rank threshold " + str(print_empirical_p_threshold))
plt.legend()
# Add annotations of age percentiles
maxValue = np.nanmax(FPR_mafPassed+FPR_cohort)
minValue = np.nanmin(FPR_mafPassed+FPR_cohort)
annotate_loc = minValue - 0.27 * (maxValue - minValue)
for i in range(num_cat + 1):
    # label = "{:.5f}".format(age_percentile[i])
    label = str(int(age_percentile[i]))
    x = np.arange(0, 101+cat_width, 100/num_cat)[i]
    y = annotate_loc
    plt.annotate(label,
                 (x,y),
                 textcoords="offset points",
                 xytext=(-1*cat_width, 0.5*cat_width),
                 annotation_clip=False,
                 color="grey",
                 rotation=30,
                 ha='left')
    plt.xticks([], minor=False)
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_mafPassedPRankLFmut" + str(LF_min) +
            "_alpha" + str(print_empirical_p_threshold) +
            "_FPRByAgecohort.png",
            dpi=300)
plt.close()


# Compare FDR～ Allele age that were calculated in two different ways
# Only mean
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FDR_mafPassed,
         color="grey",
         marker="o",
         alpha=0.6,
         label = "P-rank_all")
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FDR_cohort,
         color="mediumaquamarine",
         marker="o",
         alpha=0.6,
         label = "P-rank_cohort")
plt.xlabel("\n\nAllele age percentile bins")
plt.ylabel("False discovery rate (FP/(FP+TP))")
# plt.title(r"$\alpha$ = " + str(empirical_p_threshold))
plt.title("Rank threshold " + str(print_empirical_p_threshold))
plt.legend()
# Add annotations of age percentiles
maxValue = np.nanmax(FDR_mafPassed+FDR_cohort)
minValue = np.nanmin(FDR_mafPassed+FDR_cohort)
annotate_loc = minValue - 0.27 * (maxValue - minValue)
for i in range(num_cat + 1):
    # label = "{:.5f}".format(age_percentile[i])
    label = str(int(age_percentile[i]))
    x = np.arange(0, 101+cat_width, 100/num_cat)[i]
    y = annotate_loc
    plt.annotate(label,
                 (x,y),
                 textcoords="offset points",
                 xytext=(-1*cat_width, 0.5*cat_width),
                 annotation_clip=False,
                 color="grey",
                 rotation=30,
                 ha='left')
    plt.xticks([], minor=False)
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_mafPassedPRankLFmut" + str(LF_min) +
            "_alpha" + str(print_empirical_p_threshold) +
            "_FDRByAgecohort.png",
            dpi=300)
plt.close()


# # Performance of two methods by cohorts and runs: version2, with variation among runs
# # Not used: many nan values due to few positives
# TPR_mafPassed_runlist = []
# FPR_mafPassed_runlist = []
# FDR_mafPassed_runlist = []
# # Calculted by age cohorts
# TPR_cohort_runlist = []
# FPR_cohort_runlist = []
# FDR_cohort_runlist = []
# for i in range(num_cat):
#     age_in_range = np.logical_and(
#         df_mafPassed.loc[:, "age"] > age_percentile[i],
#         df_mafPassed.loc[:, "age"] <= age_percentile[i+1]
#     )
#     df_cohort = df_mafPassed.loc[
#         age_in_range,
#         ["relative_lf", "p", "p_rank_mafPassed", "run_id"]
#     ]
#     df_cohort.loc[:, "p_rank_cohort"] = df_cohort.groupby("run_id").rank(
#         ascending=True,
#         pct=True
#     ).loc[:, "p"]
#     TPR_mafPassed_run = []
#     FPR_mafPassed_run = []
#     FDR_mafPassed_run = []
#     # Calculted by age cohorts
#     TPR_cohort_run = []
#     FPR_cohort_run = []
#     FDR_cohort_run = []
#     for i in range(num_runs):
#         df_run = df_cohort.loc[df_cohort.loc[:,"run_id"] == i, :]
#         focal_expP = (df_run.loc[:, "relative_lf"] >= LF_min)
#         # focal_expN = df_run.loc[df_run.loc[:, "relative_lf"] < LF_min, :]
#         focal_obsP_mafPassed = (df_run.loc[:, "p_rank_mafPassed"] <
#                                empirical_p_threshold)
#         focal_obsP_cohort = (df_run.loc[:, "p_rank_cohort"] <
#                             empirical_p_threshold)
#         TP_mafPassed = sum(focal_expP & focal_obsP_mafPassed)
#         FP_mafPassed = sum(~focal_expP & focal_obsP_mafPassed)
#         FN_mafPassed = sum(focal_expP & ~focal_obsP_mafPassed)
#         TN_mafPassed = sum(~focal_expP & ~focal_obsP_mafPassed)
#         TPR_mafPassed_run.append(TP_mafPassed/(TP_mafPassed+FN_mafPassed))
#         FPR_mafPassed_run.append(FP_mafPassed/(TN_mafPassed+FP_mafPassed))
#         FDR_mafPassed_run.append(FP_mafPassed/(TP_mafPassed+FP_mafPassed))
#         # Calculated by cohorts
#         TP_cohort = sum(focal_expP & focal_obsP_cohort)
#         FP_cohort = sum(~focal_expP & focal_obsP_cohort)
#         FN_cohort = sum(focal_expP & ~focal_obsP_cohort)
#         TN_cohort = sum(~focal_expP & ~focal_obsP_cohort)
#         TPR_cohort_run.append(TP_cohort/(TP_cohort+FN_cohort))
#         FPR_cohort_run.append(FP_cohort/(TN_cohort+FP_cohort))
#         FDR_cohort_run.append(FP_cohort/(TP_cohort+FP_cohort))
#     TPR_mafPassed_runlist.append(TPR_mafPassed_run)
#     FPR_mafPassed_runlist.append(FPR_mafPassed_run)
#     FDR_mafPassed_runlist.append(FDR_mafPassed_run)
#     TPR_cohort_runlist.append(TPR_cohort_run)
#     FPR_cohort_runlist.append(FPR_cohort_run)
#     FDR_cohort_runlist.append(FDR_cohort_run)
#
#
# plt.boxplot(TPR_mafPassed_runlist)
# plt.boxplot(TPR_cohort_runlist)


# # Histogram of detectable positives
# positive_age = df_mafPassed.loc[df.loc[:, "relative_lf"] > LF_min, "age"]
# negative_age = df_mafPassed.loc[df.loc[:, "relative_lf"] < LF_min, "age"]
# plt.hist(positive_age, bins=500, stacked=True,
#          color="mediumaquamarine")
# plt.xlabel("Allele age")
# plt.ylabel("Counts")
# plt.title("Relative LF_mut>" + str(LF_min) + ", n=" + str(len(positive_age)))
# plt.savefig(figPath + model_name +
#             "_MAF0.05_histRealPositives_by_age" +
#             "_LFmut" + str(LF_min) +
#             ".png",
#             dpi=300)
# plt.close()
#
# plt.hist(negative_age, bins=500, stacked=True,
#          color="grey")
# plt.xlabel("Allele age")
# plt.ylabel("Counts")
# plt.title("Relative LF_mut<" + str(LF_min) + ", n=" + str(len(negative_age)))
# plt.savefig(figPath + model_name +
#             "_MAF0.05_histNegative_by_age" +
#             "_LFmut" + str(LF_min) +
#             ".png",
#             dpi=300)
# plt.close()


#



# Rare alleles excluded
# p,tau and false negative rate among AGE categories
# Equal numbers
# raw_p_threshold = 0.00000000000001
raw_p_threshold = 0.000000000001
print_raw_p_threshold = "{:.02e}".format(raw_p_threshold)
cat_width = int(100/num_cat) if 100 % num_cat == 0 else 100/num_cat
age_percentile = np.percentile(df_mafPassed["age"],
                               np.append(np.arange(0, 100, cat_width),
                                         100))

p_median_byAge = []
p_sd_byAge = []
tau_absMedian_byAge = []
tau_absSd_byAge = []
TPR_byAge = []
FPR_byAge = []
FDR_byAge = []
for i in range(num_cat):
    df_focal = df_mafPassed.loc[(df_mafPassed["age"] > age_percentile[i]) &
                                (df_mafPassed["age"] <= age_percentile[i+1]),
               :]
    p_category = df_focal["p"]
    tau_category = df_focal["tau"]
    relative_lf_category = df_focal["relative_lf"]
    p_median_byAge.append(np.median(p_category))
    p_sd_byAge.append(np.std(p_category))
    tau_absMedian_byAge.append(np.median(abs(tau_category)))
    tau_absSd_byAge.append(np.std(abs(tau_category)))
    mut_in_cat = len(p_category)
    expP = relative_lf_category > LF_min
    obsP = p_category < raw_p_threshold
    TP = sum(expP & obsP)
    FP = sum(~expP & obsP)
    FN = sum(expP & ~obsP)
    TN = sum(~expP & ~obsP)
    TPR_byAge.append(TP/(TP+FN))
    FPR_byAge.append(FP/(TN+FP))
    FDR_byAge.append(FP/(TP+FP))

# FPR ～ Allele age, equal number alleles per bin
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FPR_byAge,
         color="grey",
         marker = "o")
plt.xlabel("\nAllele age percentile bins")
plt.ylabel("False positive rate (FP/(FP+TN))")
plt.title("Raw p-value threshold " + str(print_raw_p_threshold))
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_FPR_vs_age_rawPvalue" + str(print_raw_p_threshold) +
            "_relativeLF"+ str(LF_min) +
            "_MAF0.05_equalNumber.png",
            dpi=300)
plt.close()

# FDR ～ Allele age, equal number alleles per bin
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         FDR_byAge,
         color="grey",
         marker = "o")
plt.xlabel("\nAllele age percentile bins")
plt.ylabel("False discovery rate (FP/(FP+TP))")
plt.title("Raw p-value threshold " + str(print_raw_p_threshold))
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_FDR_vs_age_rawPvalue" + str(print_raw_p_threshold) +
            "_relativeLF"+ str(LF_min) +
            "_MAF0.05_equalNumber.png",
            dpi=300)
plt.close()

# Neutral alleles: FDR ～ Allele age, equal number alleles per bin
x_ticks = np.append(np.arange(0, 100, cat_width),100)
# x_labels = [str(i)+"\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
x_labels = x_ticks
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         TPR_byAge,
         color="grey",
         marker="o")
plt.xlabel("\nAllele age percentile bins")
plt.ylabel("True positive rate (TP/(TP+FN))")
plt.title("Raw p-value threshold " + str(print_raw_p_threshold))
plt.xticks(ticks=x_ticks,
           labels=x_labels,
           rotation=20,
           ha='left')
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_TPR_vs_age_rawPvalue" + str(print_raw_p_threshold) +
            "_relativeLF"+ str(LF_min) +
            "_MAF0.05_equalNumber.png",
            dpi=300)
plt.close()


# p_median ～ Allele age, equal number alleles per bin
x_ticks = np.append(np.arange(0, 100, cat_width),100)
x_labels = [str(i)+"\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         p_median_byAge,
         color="grey",
         marker="o")
plt.xlabel("\nAllele age percentile bins")
plt.ylabel("Median p-values of neutral alleles")
plt.xticks(ticks=x_ticks,
           labels=x_labels)
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_GEAmedianP_vs_age_equalNumber.png",
            dpi=300)
plt.close()

# p_sd ～ Allele age, equal number alleles per bin
x_ticks = np.append(np.arange(0, 100, cat_width),100)
x_labels = [str(i)+"\n"+str(int(j)) for i,j in zip(x_ticks, age_percentile)]
plt.plot(np.arange(100/num_cat, 101, 100/num_cat) - 0.5*cat_width,
         p_sd_byAge,
         color="grey",
         marker="o")
plt.xlabel("\nAllele age percentile bins")
plt.ylabel("Standard deviation of p-values of neutral alleles")
plt.xticks(ticks=x_ticks,
           labels=x_labels)
plt.tight_layout()
plt.savefig(figPath+model_name +
            str(num_cat)+"bins" +
            "_GEAsdP_vs_age_equalNumber.png",
            dpi=300)
plt.close()



# # Signal not obvious
# # Relative LF_mut ~ cor_GE p-values RANKS, colored by age rank bins
# p_rank = df["p_rank"]
# age_rank_bin = (dataTable[1].argsort().argsort()/10000).astype(int)
# plt.scatter(p_rank, dataTable[7],
#          marker="o",
#          c=age_rank_bin, alpha=0.05)
# plt.xlabel("GEA p-values ranks")
# plt.ylabel("Relative $LF_{mut}$")
# plt.colorbar().set_label("Age rank bins \n (10 000 alleles per bin)")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_corGEpvalueRank_vs_relativeLFmut_ageBinColor2.png",
#             dpi=300)
# plt.close()

# # Histogram by allele age bins
# # Relative LF_mut ~ cor_GE p-values RANKS
# num_cat = 20
# age_percentile = np.percentile(dataTable[1],
#                                np.append(np.arange(0, 100, 100/num_cat),
#                                          100))
# lf_min = min(dataTable[7])
# lf_max = max(dataTable[7])
# for i in range(num_cat):
#     p_category = dataTable[6][np.logical_and(dataTable[1] > age_percentile[i],
#                                           dataTable[1] <= age_percentile[i+1])]
#     p_category_rank = p_category.argsort().argsort()
#     relative_LF_mut = dataTable[7][
#         np.logical_and(dataTable[1] > age_percentile[i],
#                        dataTable[1] <= age_percentile[i + 1])
#     ]
#     num_allele = len(p_category)
#     # proportion_sig.append(sum(p_category < 0.05) / num_allele)
#     plt.scatter(p_category_rank, relative_LF_mut,
#                 marker="o",
#                 c="grey", alpha=0.2)
#     plt.ylim(lf_min*1.10, lf_max*1.05)
#     plt.xlabel("GEA p-values ranks")
#     plt.ylabel("Relative $LF_{mut}$")
#     plt.title("Rank bin" + str(i) + ": \n " +
#               "age " +str(int(age_percentile[i])) +
#               "-" + str(int(age_percentile[i+1])))
#     plt.tight_layout()
#     plt.savefig(figPath + model_name + "AgeBin" + str(i) +
#                 "_corGEpvalueRank_vs_relativeLFmut.png",
#                 dpi=300)
#     plt.close()


# num_cat = 20
# # TPR ～ Allele age
# # plt.plot(np.arange(100/num_cat, 101, 100/num_cat),
# plt.plot(np.arange(0, num_cat, 1),
#          TPR,
#          color="grey",
#          marker="o")
# # Event start
# plt.axvline(num_cat*event_percentile/100,
#             color='firebrick', lw=1, dashes=(2,1))
# plt.xlabel("Allele age percentile bins")
# # plt.ylabel("Proportion of alleles with BH-adjusted p-value < 0.05")
# plt.ylabel("True positive rate (TP/(TP+FN))")
# # plt.xticks(ticks=np.arange(100/num_cat, 101, 100/num_cat),
# #            labels=[(str(i*cat_width)+"-"+str((i+1)*cat_width))
# #                    for i in range(num_cat)])
# plt.xticks(ticks=np.arange(0, num_cat, 1),
#            labels=[str(i)
#                    for i in range(num_cat)])
# plt.tick_params(axis='x', rotation=45)
# # plt.savefig(figPath+model_name+"_proportionGEABHp_vs_age.png",
# #             dpi=300)
# plt.tight_layout()
# plt.savefig(figPath+model_name+str(num_cat)+"_minLF"+str(LF_min)+"_"+
#             str(num_cat)+"bins"+"_TPR_lfmut1percent_GEABHp0.05_vs_age.png",
#             dpi=300)
# plt.close()
#
# # FPR ～ Allele age
# # plt.plot(np.arange(100/num_cat, 101, 100/num_cat),
# plt.plot(np.arange(0, num_cat, 1),
#          FPR,
#          color="grey",
#          marker="o")
# # Event start
# plt.axvline(num_cat*event_percentile/100,
#             color='firebrick', lw=1, dashes=(2,1))
# plt.xlabel("Allele age percentile bins")
# # plt.ylabel("Proportion of alleles with BH-adjusted p-value < 0.05")
# plt.ylabel("False positive rate (FP/(FP+TN))")
# # plt.xticks(ticks=np.arange(100/num_cat, 101, 100/num_cat),
# #            labels=[(str(i*cat_width)+"-"+str((i+1)*cat_width))
# #                    for i in range(num_cat)])
# plt.xticks(ticks=np.arange(0, num_cat, 1),
#            labels=[str(i)
#                    for i in range(num_cat)])
# plt.tick_params(axis='x', rotation=45)
# # plt.savefig(figPath+model_name+"_proportionGEABHp_vs_age.png",
# #             dpi=300)
# plt.tight_layout()
# plt.savefig(figPath+model_name+str(num_cat)+"_minLF"+str(LF_min)+"_"+
#             str(num_cat)+"bins"+"_FPR_lfmut1percent_GEABHp0.05_vs_age.png",
#             dpi=300)
# plt.close()
#
#
# # FDR ～ Allele age
# plt.plot(np.arange(0, num_cat, 1),
# # plt.plot(np.arange(50/num_cat, 101, 100/num_cat),
#          FDR,
#          color="grey",
#          marker="o")
# # Event start
# plt.axvline(num_cat*event_percentile/100,
#             color='firebrick', lw=1, dashes=(2,1))
# # plt.xlabel("Allele age percentile bins")
# plt.xlabel("Allele age rank bins")
# # plt.ylabel("Proportion of alleles with BH-adjusted p-value < 0.05")
# plt.ylabel("False discovery rate (FP/(FP+TP))")
# # plt.xticks(ticks=np.arange(0, 101, 100/num_cat),
# # labels=[str(i*cat_width)
# #         for i in range(num_cat)])
# plt.xticks(ticks=np.arange(0, num_cat, 1),
#            labels=[str(i)
#                    for i in range(num_cat)])
# plt.tick_params(axis='x', rotation=45)
# # plt.savefig(figPath+model_name+"_proportionGEABHp_vs_age.png",
# #             dpi=300)
# plt.tight_layout()
# plt.savefig(figPath+model_name+str(num_cat)+"_minLF"+str(LF_min)+"_"+
#             str(num_cat)+"bins"+"_FDR_lfmut1percent_GEABHp0.05_vs_age.png",
#             dpi=300)
# plt.close()


#### Cumulative plot of LF_mut ####
expected_explained_proportion = 0.8
cumulative_lf_list = []
gea_goal = []
explained = []
for i in range(num_runs):
    focal_relative_lf_mut = df.loc[df["run_id"] == i, "relative_positive_lf"]
    relative_positive_lf_mut = focal_relative_lf_mut[focal_relative_lf_mut > 0]
    sorted_lfmut = np.array(list(reversed(sorted(relative_positive_lf_mut))))
    # Trim the tails with near-0 contributions to ensure all runs have the same
    # number of mutations
    #sorted_lfmut = sorted_lfmut[0:minimum_muts-1]
    # positiveTotal = sum(sorted_lfmut)
    focal_cumulative_lf = [0] + [sum(sorted_lfmut[0:k+1])
                                 for k in range(len(sorted_lfmut))]
    #print(focal_cumulative_lf)
    # How many alleles do we need to account for 80% of current local adaptation?
    focal_gea_goal = sum(np.array(focal_cumulative_lf) < expected_explained_proportion)
    #print(focal_gea_goal)
    focal_explained = focal_cumulative_lf[focal_gea_goal]
    cumulative_lf_list.append(focal_cumulative_lf)
    gea_goal.append(focal_gea_goal)
    explained.append(focal_explained)

# Convert the "list of lists" to a numpy array by adding np.nan values to the end
max_num_positive_mut = len(max(cumulative_lf_list, key=len))
cumulative_lf = np.full(shape=(run, max_num_positive_mut), fill_value=np.nan)
for i in range(run):
    n = len(cumulative_lf_list[i])
    cumulative_lf[i][0:n] = cumulative_lf_list[i]

# mean_cumulative_lf = np.mean(cumulative_lf, axis=0)
# median_cumulative_lf = np.median(cumulative_lf, axis=0)
# mean_trim_len = np.count_nonzero(~np.isnan(mean_cumulative_lf))
# median_trim_len = np.count_nonzero(~np.isnan(median_cumulative_lf))

# Calculate mean and meadian and ignore np.nan values
mean_cumulative_lf = np.nanmean(cumulative_lf, axis=0)
median_cumulative_lf = np.nanmedian(cumulative_lf, axis=0)
mean_gea_goal = int(np.mean(gea_goal))
mean_explained = mean_cumulative_lf[mean_gea_goal]
median_gea_goal = int(np.mean(gea_goal))
median_explained = median_cumulative_lf[median_gea_goal]

# # Plot cumulative_lf: Mean with range
# for i in range(run):
#     y = np.array(cumulative_lf_list[i])
#     x = range(len(y))
#     plt.plot(x, y,
#              color="lightseagreen", alpha = 0.05)
# plt.plot(range(len(mean_cumulative_lf)), mean_cumulative_lf,
#              color="black")
# plt.xlabel("Mutations sorted in descending order of $LF_{mut}$")
# plt.ylabel("Cumulative proportion of positive LF")
#     # plt.axvline(x=mean_gea_goal, color="firebrick", linestyle="dotted")
#     # plt.axhline(y=mean_explained, color="firebrick", linestyle="dotted")
#
# plt.plot([mean_gea_goal, mean_gea_goal], [0, mean_explained],
#          color="firebrick", linestyle="dotted")
# plt.plot([0, mean_gea_goal], [mean_explained, mean_explained],
#          color="firebrick", linestyle="dotted")
# plt.annotate(str(mean_gea_goal), xy=(mean_gea_goal+1, mean_explained),
#              xytext=(mean_gea_goal + 1 + len(mean_cumulative_lf)/40, 0),
#              color="firebrick")
# plt.savefig(figPath + model_name +
#             "_meanLFcumulative_positive_100runs_meanAndRange.png",
#             dpi=300)
# plt.close()

# Plot cumulative_lf: Median with range
for i in range(run):
    y = np.array(cumulative_lf_list[i])
    x = range(len(y))
    plt.plot(x, y,
             color="lightseagreen", alpha = 0.05)
plt.plot(range(len(median_cumulative_lf)), median_cumulative_lf,
             color="black")
plt.xlabel("Mutations sorted in descending order of $LF_{mut}$")
plt.ylabel("Cumulative proportion of positive LF")
plt.plot([median_gea_goal, median_gea_goal], [0, median_explained],
         color="firebrick", linestyle="dotted")
plt.plot([0, median_gea_goal], [median_explained, median_explained],
         color="firebrick", linestyle="dotted")
plt.annotate(str(median_gea_goal), xy=(median_gea_goal+1, median_explained),
             xytext=(median_gea_goal + 1 + len(median_cumulative_lf)/40, 0),
             color="firebrick")
plt.savefig(figPath + model_name +
            "_medianLFcumulative_positive_100runs_medianAndRange.png",
            dpi=300)
plt.close()



# Sum of LF of the size class ~ |phenotypic effect size|
# Sum of LF of the size class ~ |phenotypic effect size|, separating positive and negative parts
# # Methods 1: runs combined
# num_cat = 20 # Number of categories for allele age
# abs_effect = abs(df["mut_effect"])
# LF_total = sum(df["delta_LF_mut"])
# # LF_positive = sum(df["delta_LF_mut"][df["delta_LF_mut"] > 0])
# # LF_negative = sum(df["delta_LF_mut"][df["delta_LF_mut"] < 0])
# lf_sum = []
# lf_sum_positive = []
# lf_sum_negative = []
# alpha_cats = np.append(np.arange(0, max(abs_effect), max(abs_effect)/num_cat),
#                        max(abs_effect))
# for i in range(num_cat):
#     lf_category = df["delta_LF_mut"][np.logical_and(abs_effect > alpha_cats[i],
#                                               abs_effect <= alpha_cats[i+1])]
#     lf_sum.append(sum(lf_category/LF_total))
#     lf_sum_positive.append(sum(lf_category[lf_category > 0]) / LF_total)
#     lf_sum_negative.append(sum(lf_category[lf_category < 0]) / LF_total)
#
# #total LF of the size ~ |phenotypic effect size|
# plt.figure(1)
# plt.plot(alpha_cats[1:],
#          lf_sum,
#          color="grey")
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("Relative contribution to local adaptation from the size class")
# # plt.xticks(ticks=np.arange(100/num_cat, 101, 100/num_cat),
# #            labels=[(str(i*cat_width)+"-"+str((i+1)*cat_width))
# #                    for i in range(num_cat)])
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
#             "_LF_by_absEffectSize_bin.png",
#             dpi=300)
# plt.close()
#
# # total LF of the size ~ |phenotypic effect size|, separated by positive and
# # negative contributions
# plt.figure(1)
# lf_sum_positive = np.array(lf_sum_positive)
# lf_sum_negative = np.array(lf_sum_negative)
# x = alpha_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# fig, ax = plt.subplots()
# ax.plot(x, y1, color="mediumaquamarine",
#         label="Positive")
# ax.plot(x, y2, color="saddlebrown",
#         label="Negative")
# ax.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("Relative contribution to local adaptation from the size class")
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
# plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins" +
#             "_LF_by_absEffectSize_bin_positveAndnegative.png",
#             dpi=300)
# plt.close()

# Sum of LF of the size class ~ |phenotypic effect size|, separating positive and negative parts
# Methods 2: relative to the total LF of each run
num_cat = 20 # Number of categories for phenotypic effect
abs_effect = abs(df["mut_effect"])
lf_sum = []
lf_sum_positive = []
lf_sum_negative = []
alpha_cats = np.append(np.arange(0, max(abs_effect), max(abs_effect)/num_cat),
                       max(abs_effect))
for i in range(num_cat):
    lf_category = df["relative_lf"][np.logical_and(abs_effect > alpha_cats[i],
                                              abs_effect <= alpha_cats[i+1])]
    lf_sum.append(sum(lf_category)/num_runs)
    lf_sum_positive.append(sum(lf_category[lf_category > 0])/num_runs)
    lf_sum_negative.append(sum(lf_category[lf_category < 0])/num_runs)

# total LF of the size ~ |phenotypic effect size|, separated by positive and
# negative contributions
# # line plot: Not used
# plt.figure(1)
# lf_sum_positive = np.array(lf_sum_positive)
# lf_sum_negative = np.array(lf_sum_negative)
# x = alpha_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# fig, ax = plt.subplots()
# ax.plot(x, y1, color="mediumaquamarine",
#         label="Positive")
# ax.plot(x, y2, color="saddlebrown",
#         label="Negative")
# ax.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("Relative contribution to local adaptation from the size class")
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
# plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
#             "_LF_by_absEffectSize_bin_positveAndnegative_lfRelative2EachRun.png",
#             dpi=300)
# plt.close()

# barplot
plt.figure(1)
lf_sum_positive = np.array(lf_sum_positive)
lf_sum_negative = np.array(lf_sum_negative)
x = alpha_cats[1:]
y1 = lf_sum_positive
y2 = lf_sum_negative
fig, ax = plt.subplots()
bar_width = 0.002 # High polygenicity
# bar_width = 0.016 # Low polygenicity
ax.bar(x, y1, color="mediumaquamarine",
        label="Positive",
       width=bar_width)
ax.bar(x, y2, color="saddlebrown",
        label="Negative",
       width=bar_width)
ax.axhline(0, color='grey', lw=1, dashes=(1,1))
plt.xlabel("|Mutation phenotypic effect size|")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the size class")

plt.xlim(0, 0.05) # High polygenicity
# plt.xlim(0, 0.40) # Low polygenicity
plt.ylim(-0.08, 0.2)
ax.legend(loc="upper right")
ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
ax.margins(x=0)
plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
            "_LF_by_absEffectSize_bin_positveAndnegative_lfRelative2EachRun_barPlot.png",
            dpi=300)
plt.close()



# Sum of LF from the age class ~ Allele age
num_cat = 100 # Number of categories for allele age
# lf_sum = []
lf_sum_positive = []
lf_sum_negative = []
# age = np.log10(df["age"])
age = df["age"]
age_cats = np.append(np.arange(0, tick, tick/num_cat),
                     tick)
for i in range(num_cat):
    lf_category = df["relative_lf"][np.logical_and(age > age_cats[i],
                                              age <= age_cats[i+1])]
    # lf_sum.append(sum(lf_category)/num_runs)
    lf_sum_positive.append(sum(lf_category[lf_category > 0])/num_runs)
    lf_sum_negative.append(sum(lf_category[lf_category < 0])/num_runs)

#total LF of the age class ~ allele age, separated by positive and
# #negative contributions
# # line plot: Not used
# plt.figure(1)
# lf_sum_positive = np.array(lf_sum_positive)
# lf_sum_negative = np.array(lf_sum_negative)
# x = age_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# fig, ax = plt.subplots()
# ax.plot(x, y1, color="mediumaquamarine",
#         label="Positive")
# ax.plot(x, y2, color="saddlebrown",
#         label="Negative")
# ax.axhline(0, color='grey', lw=1, dashes=(1,1))
# ax.axvline(np.log10(event_age), color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
# plt.tick_params(axis='x', rotation=45)
# plt.xlabel("Allele age (generation)")
# plt.ylabel("Total relative contribution to local adaptation" +
#            "\n" + "from the age class")
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
#             "_LF_by_age_bin_positveAndnegative_lfRelative2EachRun.png",
#             dpi=300)
# plt.close()

# # bar plot: in log10 scale
# plt.figure(1)
# lf_sum_positive = np.array(lf_sum_positive)
# lf_sum_negative = np.array(lf_sum_negative)
# x = age_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# plt.bar(x, y1, color="mediumaquamarine",
#        label="Positive",
#        width=0.18)
# plt.bar(x, y2, color="saddlebrown",
#        label="Negative",
#        width=0.18)
# plt.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.axvline(np.log10(event_age), color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
# plt.tick_params(axis='x', rotation=45)
# plt.xlabel("Allele age (generation)")
# plt.ylabel("Total relative contribution to local adaptation" +
#            "\n" + "from the age class")
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# # ax.margins(x=0)
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
#             "_LF_by_log10age_bin_positveAndnegative_lfRelative2EachRun.png",
#             dpi=300)
# plt.close()

# bar plot
plt.figure(1)
lf_sum_positive = np.array(lf_sum_positive)
lf_sum_negative = np.array(lf_sum_negative)
x = age_cats[1:]
y1 = lf_sum_positive
y2 = lf_sum_negative
plt.bar(x, y1, color="mediumaquamarine",
       label="Positive",
       width=max(age)*0.9/num_cat)
plt.bar(x, y2, color="saddlebrown",
       label="Negative",
       width=max(age)*0.9/num_cat)
# plt.xlim(0, tick*1.05)
plt.axhline(0, color='grey', lw=1, dashes=(1,1))
plt.axvline(event_age, color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), max(x)/10),
#            labels=['{:0.2e}'.format(i)
#                    for i in np.arange(0, max(x), max(x)/10)])
plt.xticks(ticks=range(0, tick+1, 10000),
           labels=[str(i) for i in range(0, tick+1, 10000)])
plt.tick_params(axis='x', rotation=45)
plt.xlabel("Allele age (generation)")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the age class")
plt.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
plt.tight_layout()
plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
            "_LF_by_age_bin_positveAndnegative_lfRelative2EachRun.png",
            dpi=300)
plt.close()



# Contribute to local adaptation by frequency bins
# Sum of LF from the age class ~ Allele age
num_cat = 25 # Number of categories for allele age
# lf_sum = []
lf_sum_positive = []
lf_sum_negative = []
freq = df["freq"]
freq_cats = np.append(np.arange(0, 1, 1.0/num_cat),
                     1)
for i in range(num_cat):
    lf_category = df["relative_lf"][np.logical_and(freq > freq_cats[i],
                                              freq <= freq_cats[i+1])]
    lf_sum.append(sum(lf_category)/num_runs)
    lf_sum_positive.append(sum(lf_category[lf_category > 0])/num_runs)
    lf_sum_negative.append(sum(lf_category[lf_category < 0])/num_runs)

# bar plot
# plt.figure(1)
lf_sum_positive = np.array(lf_sum_positive)
lf_sum_negative = np.array(lf_sum_negative)
x = freq_cats[1:]
y1 = lf_sum_positive
y2 = lf_sum_negative
plt.bar(x, y1, color="mediumaquamarine",
       label="Positive",
       width=0.035)
plt.bar(x, y2, color="saddlebrown",
       label="Negative",
       width=0.035)
# plt.ylim(-0.1, 0.2) #temperary use
plt.ylim(-0.25, 0.35) # A value for all 8 combinations
plt.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
# plt.tick_params(axis='x', rotation=45)
plt.xlabel("Frequency")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the frequency class")
ax.legend(loc="upper right")
ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
plt.tight_layout()
plt.savefig(figPath+model_name+"_"+str(num_cat) + "bins"+
            "_LF_by_log10freq_bin_positveAndnegative_lfRelative2EachRun.png",
            dpi=300)
plt.close()



# # Three-way relationship among allele freq, effect size and contribution to LF
# df_polymorphic = df[(df["freq"] != 1) & (df["freq"] != 0)]
# max_lf = max(df_polymorphic["delta_LF_mut"])
# min_lf = min(df_polymorphic["delta_LF_mut"])
# plt.scatter(abs(df_polymorphic["mut_effect"]), df_polymorphic["delta_LF_mut"],
#             marker="o", c=df_polymorphic["freq"], alpha=0.1, s=20)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.colorbar().set_label("Allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_frequencyColor.png",
#             dpi=300)
# plt.close()
#
# # Use minor allele frequency
# minor_freq = []
# for f in df_polymorphic["freq"]:
#     if f <= 0.5:
#         minor_freq.append(f)
#     else:
#         minor_freq.append(1-f)
# minor_freq = np.array(minor_freq)
#
# # # Dot plots that look good but not useful
# maf_mafPassed = 0.5-abs(df_mafPassed["freq"]-0.5)
# plt.scatter(abs(df_mafPassed["mut_effect"]), df_mafPassed["relative_lf"],
#             marker="o", c=df_mafPassed["freq"],
#             alpha=0.1, s=20)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("Relative $LF_{mut}$")
# # plt.xlim(left=0,
# #          right=0.05)
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_relativeLFmut_by_effectSize_frequencyColor.png",
#             dpi=300)
# plt.close()
#
# # p-rank ~ relative lf_mut, colored by MAF
# plt.scatter(df_mafPassed["relative_lf"],
#             -np.log10(df_mafPassed["p_rank_mafPassed"]),
#             marker="o", c=maf_mafPassed,
#             alpha=0.1, s=20)
# plt.xlabel("Relative $LF_{mut}$")
# plt.ylabel("-log10(Relative ranks of p-values among all alleles with MAF > 0.05)")
# # plt.xlim(left=0,
# #          right=0.05)
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+
#             "_log10pRank_MAFpassed_by_relativeLF_minorFrequencyColor.png",
#             dpi=300)
# plt.close()
#
# # p-rank ~ |phenotypic effect size|, colored by MAF
# plt.scatter(abs(df_mafPassed["mut_effect"]),
#             -np.log10(df_mafPassed["p_rank_mafPassed"]),
#             marker="o", c=maf_mafPassed,
#             alpha=0.1, s=20)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("-log10(Relative ranks of p-values among all alleles with MAF > 0.05)")
# # plt.xlim(left=0,
# #          right=0.05)
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+
#             "_log10pRank_MAFpassed_by_absEffectSize_minorFrequencyColor.png",
#             dpi=300)
# plt.close()
#
# # p-rank ~ relative lf_mut, colored by log age
# plt.scatter(df_mafPassed["relative_lf"],
#             -np.log10(df_mafPassed["p_rank_mafPassed"]),
#             marker="o", c=np.log10(df_mafPassed["age"]),
#             alpha=0.1, s=20)
# plt.xlabel("Relative $LF_{mut}$")
# plt.ylabel("-log10(Relative ranks of p-values among all alleles with MAF > 0.05)")
# # plt.xlim(left=0,
# #          right=0.05)
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Log10(allele age)")
# plt.tight_layout()
# plt.savefig(figPath+model_name+
#             "_log10pRank_MAFpassed_by_relativeLF_log10AgeColor.png",
#             dpi=300)
# plt.close()
#
# # p-rank ~ |phenotypic effect size|, colored by log age
# plt.scatter(abs(df_mafPassed["mut_effect"]),
#             -np.log10(df_mafPassed["p_rank_mafPassed"]),
#             marker="o", c=np.log10(df_mafPassed["age"]),
#             alpha=0.1, s=20)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("-log10(Relative ranks of p-values among all alleles with MAF > 0.05)")
# # plt.xlim(left=0,
# #          right=0.05)
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Allele age")
# plt.tight_layout()
# plt.savefig(figPath+model_name+
#             "_log10pRank_MAFpassed_by_absEffectSize_log10AgeColor.png",
#             dpi=300)
# plt.close()

# plt.scatter(abs(df_polymorphic["mut_effect"]), df_polymorphic["delta_LF_mut"],
#             marker="o", c=minor_freq,
#             alpha=0.1, s=20)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.xlim(left=0,
#          right=0.05)
# plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_minorFrequencyColor.png",
#             dpi=300)
# plt.close()

# Separated by high and low frequencies
# df_middleFreq = df_polymorphic[(df_polymorphic["freq"] >= 0.25) &
#                                (df_polymorphic["freq"] < 0.75)]
# df_lowHighFreq = df_polymorphic[(df_polymorphic["freq"] >= 0.75) |
#                                 (df_polymorphic["freq"] < 0.25)]

# plt.scatter(abs(df_middleFreq["mut_effect"]),
#             df_middleFreq["delta_LF_mut"],
#             marker="o", c=df_middleFreq["freq"],
#             alpha=0.1, s=20,
#             vmin=0, vmax=1)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.xlim(left=min(abs(df_polymorphic["mut_effect"])),
#          right=max(abs(df_polymorphic["mut_effect"])))
# plt.ylim(bottom=min_lf, top=max_lf)
# plt.colorbar().set_label("Allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_frequencyColor_middleFreq.png",
#             dpi=300)
# plt.close()
#
# plt.scatter(abs(df_lowHighFreq["mut_effect"]),
#             df_lowHighFreq["delta_LF_mut"],
#             marker="o", c=df_lowHighFreq["freq"],
#             alpha=0.1, s=20,
#             vmin=0, vmax=1)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.xlim(left=min(abs(df_polymorphic["mut_effect"])),
#          right=max(abs(df_polymorphic["mut_effect"])))
# plt.ylim(bottom=min_lf, top=max_lf)
# plt.colorbar().set_label("Allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_frequencyColor_lowHighFreq.png",
#             dpi=300)
# plt.close()

# #Minor allele frequency: separate 0-0.25, 0.25-0.5
# df_middleFreq = df_polymorphic[minor_freq >= 0.25]
# df_lowHighFreq = df_polymorphic[minor_freq < 0.25]
# plt.scatter(abs(df_middleFreq["mut_effect"]),
#             df_middleFreq["delta_LF_mut"],
#             marker="o", c=minor_freq[minor_freq >= 0.25],
#             alpha=0.1, s=20,
#             vmin=0, vmax=0.5)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.xlim(left=0,
#          right=0.05)
# plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_frequencyColor_highMinorFreq.png",
#             dpi=300)
# plt.close()
#
# plt.scatter(abs(df_lowHighFreq["mut_effect"]),
#             df_lowHighFreq["delta_LF_mut"],
#             marker="o", c=minor_freq[minor_freq < 0.25],
#             alpha=0.1, s=20,
#             vmin=0, vmax=0.5)
# plt.xlabel("|Mutation phenotypic effect size|")
# plt.ylabel("$LF_{mut}$")
# plt.xlim(left=0,
#          right=0.05)
# plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effectSize_vs_LFmut_frequencyColor_lowMinorFreq.png",
#             dpi=300)
# plt.close()


# #Three-way relationship 1: log (mislading)
# # Sum of LF from the age class ~ Allele age Colored by |effect size|
# num_age_cat = 25 # Number of categories for allele age
# num_size_cat = 5 # Number of categories for phenotypic effect size
# # lf_sum = []
# lf_sum_positive = np.full(shape=(5, 25), fill_value=np.nan)
# lf_sum_negative = np.full(shape=(5, 25), fill_value=np.nan)
# age = np.log10(df["age"])
# size = df["mut_effect"]
# # age = df["age"]
# age_cats = np.append(np.arange(0, max(age), max(age)/num_age_cat),
#                      max(age))
# size_cats = np.array([0, 0.01, 0.02, 0.03, 0.04, max(df["mut_effect"])]) # Hard coded
# for i in range(num_age_cat):
#     for j in range(num_size_cat):
#         focal_range = np.logical_and(np.logical_and(age > age_cats[i],
#                                                     age <= age_cats[i + 1]),
#                                      np.logical_and(abs(size) > size_cats[j],
#                                                     abs(size) <= size_cats[j + 1]))
#         lf_category = df["relative_lf"][focal_range]
#         lf_sum_positive[j][i] = (sum(lf_category[lf_category > 0])/num_runs)
#         lf_sum_negative[j][i] = (sum(lf_category[lf_category < 0])/num_runs)
#
# # bar plot
# plt.figure(1)
# x = age_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# colors = ["#FDE257FF", "#95D840FF", "#29AF7FFF","#287D8EFF","#440154FF"]
# patch1 = mpatches.Patch(color=colors[0], label='0-0.01')
# patch2 = mpatches.Patch(color=colors[1], label='0.01-0.02')
# patch3 = mpatches.Patch(color=colors[2], label='0.02-0.03')
# patch4 = mpatches.Patch(color=colors[3], label='0.03-0.04')
# patch5 = mpatches.Patch(color=colors[4], label='> 0.04')
# # Initialize the vertical-offset for the stacked bar chart.
# y_offset = np.zeros(num_age_cat)
# bar_width = 0.2
# for row in range(num_size_cat):
#     plt.bar(x, y1[row], bar_width, bottom=y_offset, color=colors[row])
#     y_offset = y_offset + lf_sum_positive[row]
# plt.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.axvline(np.log10(event_age), color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
# plt.tick_params(axis='x', rotation=45)
# plt.xlabel("Allele age (generation)")
# plt.ylabel("Total relative contribution to local adaptation" +
#            "\n" + "from the age class")
# plt.ylim(0, 0.8)
# plt.legend(handles=[patch5, patch4, patch3, patch2, patch1],
#            title="|Mutation phenotypic effect size|",
#            loc="upper left")
# # ax.legend(loc="upper right")
# # ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# # ax.margins(x=0)
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_"+str(num_age_cat) + "bins"+
#             "_LF_by_log10age_bin_positve_lfRelative2EachRun_sizeColor.png",
#             dpi=300)
# plt.close()
#
# #Three-way relationship 2: log (mislading)
# # Sum of LF from the age class ~ Allele age, Colored by frequency
# num_age_cat = 25 # Number of categories for allele age
# num_freq_cat = 10 # Number of categories for allele frequency
# # lf_sum = []
# lf_sum_positive = np.full(shape=(10, 25), fill_value=np.nan)
# lf_sum_negative = np.full(shape=(10, 25), fill_value=np.nan)
# age = np.log10(df["age"])
# freq = df["freq"]
# # age = df["age"]
# age_cats = np.append(np.arange(0, max(age), max(age)/num_age_cat),
#                      max(age))
# freq_cats = np.arange(0,1.1, 0.1) # Hard coded
# for i in range(num_age_cat):
#     for j in range(num_freq_cat):
#         focal_range = np.logical_and(np.logical_and(age > age_cats[i],
#                                                     age <= age_cats[i + 1]),
#                                      np.logical_and(freq > freq_cats[j],
#                                                     freq <= freq_cats[j + 1]))
#         lf_category = df["relative_lf"][focal_range]
#         lf_sum_positive[j][i] = (sum(lf_category[lf_category > 0])/num_runs)
#         lf_sum_negative[j][i] = (sum(lf_category[lf_category < 0])/num_runs)
#
# # bar plot
# plt.figure(1)
# x = age_cats[1:]
# y1 = lf_sum_positive
# y2 = lf_sum_negative
# # colors = ["#f2e5f9FF", "#dbcee9FF", "#b9a1d3FF", "#9B7DC5FF", "#7757adFF",
# #           "#623f9cFF", "#51308cFF", "#3c1e7aFF", "#2c0f70FF", "#200462FF"]
# colors = ["#d2ebf3FF", "#9dcde3FF", "#6899CEFF", "#4074cbFF", "#1839aaFF",
#           "#1624a1FF", "#523cb7FF", "#8f69caFF", "#c2a0dfFF", "#e5d0f0FF"]
# patch1 = mpatches.Patch(color=colors[0], label='0-0.1')
# patch2 = mpatches.Patch(color=colors[1], label='0.1-0.2')
# patch3 = mpatches.Patch(color=colors[2], label='0.2-0.3')
# patch4 = mpatches.Patch(color=colors[3], label='0.3-0.4')
# patch5 = mpatches.Patch(color=colors[4], label='0.4-0.5')
# patch6 = mpatches.Patch(color=colors[5], label='0.5-0.6')
# patch7 = mpatches.Patch(color=colors[6], label='0.6-0.7')
# patch8 = mpatches.Patch(color=colors[7], label='0.7-0.8')
# patch9 = mpatches.Patch(color=colors[8], label='0.8-0.9')
# patch10 = mpatches.Patch(color=colors[9], label='0.9-1.0')
#
# # Initialize the vertical-offset for the stacked bar chart.
# y_offset = np.zeros(num_age_cat)
# bar_width = 0.2
# for row in range(num_freq_cat):
#     plt.bar(x, y1[row], bar_width, bottom=y_offset, color=colors[row])
#     y_offset = y_offset + lf_sum_positive[row]
# plt.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.axvline(np.log10(event_age), color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
# plt.tick_params(axis='x', rotation=45)
# plt.xlabel("Allele age (generation)")
# plt.ylabel("Total relative contribution to local adaptation" +
#            "\n" + "from the age class")
# plt.ylim(0, 0.8)
# plt.legend(handles=[patch10, patch9, patch8, patch7, patch6,
#                     patch5, patch4, patch3, patch2, patch1],
#            title="Allele frequency",
#            loc="upper left")
# # ax.legend(loc="upper right")
# # ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# # ax.margins(x=0)
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_"+str(num_age_cat) + "bins"+
#             "_LF_by_log10age_bin_positve_lfRelative2EachRun_freqColor.png",
#             dpi=300)
# plt.close()

#Three-way relationship 1: no log
# Sum of LF from the age class ~ Allele age Colored by |effect size|
age = df["age"]
size = abs(df["mut_effect"])
num_age_cat = 100 # Number of categories for allele age
num_size_cat = 10 # up to 10 but can be fewer
size_cats_step = 0.01
size_last_tick = 0.1 # temporary
max_abs_size = max(size)
if size_last_tick > max_abs_size:
    num_size_cat = round(max(size) / size_cats_step)  # Number of categories for phenotypic effect size
    size_last_tick = size_cats_step*num_size_cat
# lf_sum = []
lf_sum_positive_size = np.full(shape=(10, 100), fill_value=np.nan)
lf_sum_negative_size = np.full(shape=(10, 100), fill_value=np.nan)
age_cats = np.append(np.arange(0, max(age), max(age)/num_age_cat),
                     max(age))
size_cats = np.r_[np.arange(0, size_last_tick, size_cats_step), max(size)]
for i in range(num_age_cat):
    for j in range(num_size_cat):
        focal_range = np.logical_and(np.logical_and(age > age_cats[i],
                                                    age <= age_cats[i+1]),
                                     np.logical_and(abs(size) > size_cats[j],
                                                    abs(size) <= size_cats[j+1]))
        lf_category = df["relative_lf"][focal_range]
        lf_sum_positive_size[j][i] = (sum(lf_category[lf_category > 0])/num_runs)
        lf_sum_negative_size[j][i] = (sum(lf_category[lf_category < 0])/num_runs)

y1 = lf_sum_positive_size
y2 = lf_sum_negative_size
# bar plot
plt.figure(1)
x = age_cats[1:]
# colors = ["#FDE257FF", "#95D840FF", "#29AF7FFF","#287D8EFF","#440154FF"]
# viridis 10 categories
colors = ["#FDE725FF", "#AADC32FF", "#5DC863FF", "#27AD81FF", "#1F9A8AFF",
          "#287C8EFF", "#365D8DFF","#443A83FF", "#481F70FF", "#440154FF"]
patches = []
for i in range(num_size_cat-1):
    patches.append(mpatches.Patch(color=colors[i], label= str(i*size_cats_step) +
                                                          "-" + str((i+1)*size_cats_step)))
#The last patch:
patches.append(mpatches.Patch(color=colors[num_size_cat-1], label="> " + str(round(size_last_tick-size_cats_step,2))))
# Initialize the vertical-offset for the stacked bar chart.
bar_width = tick/110
y_offset = np.zeros(num_age_cat)
for row in range(num_size_cat):
    plt.bar(x, y1[row], bar_width, bottom=y_offset, color=colors[row])
    y_offset = y_offset + y1[row]
y_offset = np.zeros(num_age_cat)
for row in range(num_size_cat):
    plt.bar(x, y2[row], bar_width, bottom=y_offset, color=colors[row])
    y_offset = y_offset + y2[row]
plt.axhline(0, color='grey', lw=1, dashes=(1,1))
plt.axvline(event_age, color='firebrick', lw=1, dashes=(2,1), zorder=0)
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
plt.tick_params(axis='x', rotation=45)
plt.xlabel("Allele age (generation)")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the age class")
plt.ylim(np.min(np.nansum(y2, axis = 0))*1.2, np.max(np.nansum(y1, axis=0))*1.2)
plt.legend(handles=patches,
           title="|Mutation phenotypic effect size|",
           loc="upper center")
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
plt.tight_layout()
plt.savefig(figPath+model_name+"_"+str(num_age_cat) + "bins"+
            "_LF_by_age_bin_positve_lfRelative2EachRun_sizeColor.png",
            dpi=300)
plt.close()



#Three-way relationship 2: no log
# Sum of LF from the age class ~ Allele age, Colored by frequency
num_age_cat = 100 # Number of categories for allele age
num_freq_cat = 10 # Number of categories for allele frequency
freq_cats_step = 0.1
freq_last_tick = 1.1 # not inclueded
# lf_sum = []
lf_sum_positive_freq = np.full(shape=(10, 100), fill_value=np.nan)
lf_sum_negative_freq = np.full(shape=(10, 100), fill_value=np.nan)
age = df["age"]
freq = df["freq"]

age_cats = np.append(np.arange(0, max(age), max(age)/num_age_cat),
                     max(age))
freq_cats = np.arange(0, freq_last_tick, freq_cats_step)
for i in range(num_age_cat):
    for j in range(num_freq_cat):
        focal_range = np.logical_and(np.logical_and(age > age_cats[i],
                                                    age <= age_cats[i + 1]),
                                     np.logical_and(freq > freq_cats[j],
                                                    freq <= freq_cats[j + 1]))
        lf_category = df["relative_lf"][focal_range]
        lf_sum_positive_freq[j][i] = (sum(lf_category[lf_category > 0])/num_runs)
        lf_sum_negative_freq[j][i] = (sum(lf_category[lf_category < 0])/num_runs)

y1 = lf_sum_positive_freq
y2 = lf_sum_negative_freq

# bar plot
plt.figure(1)
x = age_cats[1:]
# colors = ["#f2e5f9FF", "#dbcee9FF", "#b9a1d3FF", "#9B7DC5FF", "#7757adFF",
#           "#623f9cFF", "#51308cFF", "#3c1e7aFF", "#2c0f70FF", "#200462FF"]
colors = ["#d2ebf3FF", "#9dcde3FF", "#6899CEFF", "#4074cbFF", "#1839aaFF",
          "#1624a1FF", "#523cb7FF", "#8f69caFF", "#c2a0dfFF", "#e5d0f0FF"]
patches = []
for i in range(num_freq_cat):
    patches.append(mpatches.Patch(color=colors[i], label= str(round(i*freq_cats_step, 2)) +
                                                          "-" + str(round((i+1)*freq_cats_step, 2))))
# Initialize the vertical-offset for the stacked bar chart.
bar_width = tick/110
y_offset = np.zeros(num_age_cat)
for row in range(num_freq_cat):
    plt.bar(x, y1[row], bar_width, bottom=y_offset, color=colors[row])
    y_offset = y_offset + y1[row]
y_offset = np.zeros(num_age_cat)
for row in range(num_freq_cat):
    plt.bar(x, y2[row], bar_width, bottom=y_offset, color=colors[row])
    y_offset = y_offset + y2[row]
plt.axhline(0, color='grey', lw=1, dashes=(1,1))
plt.axvline(event_age, color='firebrick', lw=1, dashes=(2,1),zorder=0)
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in 10**np.arange(0, max(x), 1)])
plt.tick_params(axis='x', rotation=45)
plt.xlabel("Allele age (generation)")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the age class")
plt.ylim(np.min(np.sum(y2, axis = 0))*1.2, np.max(np.sum(y1, axis=0))*1.2)
plt.legend(handles=patches,
           title="Allele frequency",
           loc="upper center",
           ncols=2)
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
plt.tight_layout()
plt.savefig(figPath+model_name+"_"+str(num_age_cat) + "bins"+
            "_LF_by_age_bin_positve_lfRelative2EachRun_freqColor.png",
            dpi=300)
plt.close()


#Three-way relationship 3: no log
# Sum of LF from the size class ~ Effect size, Colored by frequency
abs_size = abs(df["mut_effect"])
num_size_cat = 20 # Number of categories for phenotypic effect
num_freq_cat = 10 # Number of categories for allele frequency
lf_sum_positive = np.full(shape=(10, 20), fill_value=np.nan)
lf_sum_negative = np.full(shape=(10, 20), fill_value=np.nan)
size_cats = np.append(np.arange(0, max(abs_size), max(abs_size)/num_size_cat),
                       max(abs_size))
freq_cats = np.arange(0,1.1, 0.1) # Hard coded
for i in range(num_size_cat):
    for j in range(num_freq_cat):
        focal_range = np.logical_and(np.logical_and(abs_size > size_cats[i],
                                                    abs_size <= size_cats[i + 1]),
                                     np.logical_and(freq > freq_cats[j],
                                                    freq <= freq_cats[j + 1]))
        lf_category = df["relative_lf"][focal_range]
        lf_sum_positive[j][i] = (sum(lf_category[lf_category > 0])/num_runs)
        lf_sum_negative[j][i] = (sum(lf_category[lf_category < 0])/num_runs)

# bar plot
plt.figure(1)
x = size_cats[1:]
y1 = lf_sum_positive
y2 = lf_sum_negative
# colors = ["#f2e5f9FF", "#dbcee9FF", "#b9a1d3FF", "#9B7DC5FF", "#7757adFF",
#           "#623f9cFF", "#51308cFF", "#3c1e7aFF", "#2c0f70FF", "#200462FF"]
colors = ["#d2ebf3FF", "#9dcde3FF", "#6899CEFF", "#4074cbFF", "#1839aaFF",
          "#1624a1FF", "#523cb7FF", "#8f69caFF", "#c2a0dfFF", "#e5d0f0FF"]
patches = []
for i in range(num_freq_cat):
    patches.append(mpatches.Patch(color=colors[i], label= str(round(i*freq_cats_step, 2)) +
                                                          "-" + str(round((i+1)*freq_cats_step, 2))))
# Initialize the vertical-offset for the stacked bar chart.
y_offset = np.zeros(num_size_cat)
bar_width = 0.002 # High polygenicity
# bar_width = 0.016 # Low polygenicity
for row in range(num_freq_cat):
    plt.bar(x, y1[row], bar_width, bottom=y_offset, color=colors[row])
    y_offset = y_offset + lf_sum_positive[row]
plt.axhline(0, color='grey', lw=1, dashes=(1,1))
# plt.axvline(np.log10(event_age), color='firebrick', lw=1, dashes=(2,1))
# plt.xticks(ticks=np.arange(0, max(x), 1),
#            labels=['{:0.2e}'.format(i)
#                    for i in np.arange(0, max(x), 0.005)])
plt.tick_params(axis='x', rotation=45)
plt.xlabel("|Mutation phenotypic effect size|")
plt.ylabel("Total relative contribution to local adaptation" +
           "\n" + "from the size class")
plt.ylim(0, 0.8)
plt.legend(handles=patches,
           title="Allele frequency",
           loc="upper right")
plt.xlim(0, 0.05) # High polygenicity
# plt.xlim(0, 0.40) # Low polygenicity
plt.ylim(0, 0.2)
# ax.legend(loc="upper right")
# ax.yaxis.set_major_formatter(lambda x, pos: f'{abs(x):g}')
# ax.margins(x=0)
plt.tight_layout()
plt.savefig(figPath+model_name+"_"+str(num_size_cat) + "bins"+
            "_LF_by_size_bin_positve_lfRelative2EachRun_freqColor.png",
            dpi=300)
plt.close()


# # GEA results ~ Allele age for neutral alleles
# # len(df["mut_effect"])
# # sum(df["mut_effect"] == 0)
# plt.scatter(np.log10(df["age"]),
#             abs(df["tau"]),
#             marker="o",
#             # c=df["freq"],
#             c="grey",
#             alpha=0.01, s=10,
#             vmin=0, vmax=0.5)
# plt.xlabel("log10(Allele age)")
# plt.ylabel("|Kendall's tau|")
# plt.xlim(left=0)
# plt.axvline(np.log10(event_age), color='firebrick', lw=1.5, dashes=(2,1))
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_effect0Mut_absTau_vs_log10age_frequencyColor_legend2.png",
#             dpi=300)
# plt.close()
#
# plt.scatter(np.log10(df["age"]),
#             df["p_rank"],
#             marker="o", c=df["freq"],
#             alpha=0.01, s=20,
#             vmin=0, vmax=0.5)
# plt.xlabel("log10(Allele age)")
# plt.ylabel("GEA p-values")
# plt.xlim(left=0)
# plt.axvline(np.log10(event_age), color='firebrick', lw=1.5, dashes=(2,1))
# # plt.ylim(bottom=-0.004, top=0.016)
# plt.colorbar().set_label("Minor allele Frequency")
# plt.tight_layout()
# plt.savefig(figPath+model_name+"_pRank_vs_log10age_frequencyColor.png",
#             dpi=300)
# plt.close()

